var Chatter=function(){this.VERSION="1.1.2",this.loaded=!1,this.settings=chrome.storage.local,this.enabled;var e=!1;this.updateloop,this.user_count=0,this.colors=["YellowGreen","SteelBlue","Crimson","LimeGreen","CornflowerBlue","Violet","LightSkyBlue","SaddleBrown","DarkOrange","SeaGreen","MediumVioletRed","DarkTurquoise","Olive","Tomato","DarkOliveGreen","Turquoise","DarkRed","Purple","Maroon","RebeccaPurple","DarkCyan","MediumBlue","HotPink","DeepPink","CadetBlue","PaleVioletRed","DarkOrchid","MediumPurple","Brown","DeepSkyBlue","DodgerBlue","SlateBlue","OliveDrab","OrangeRed","Coral","Chocolate","Red","LightCoral","FireBrick","LightSeaGreen","MediumSlateBlue","DarkMagenta","Teal","Orchid","MidnightBlue","Orange","MediumAquaMarine","Green","DarkSalmon","DarkBlue","Navy","DarkGoldenRod","Fuchsia","SkyBlue","ForestGreen","MediumSeaGreen","DarkViolet","RosyBrown","DarkSlateBlue","DarkSeaGreen","RoyalBlue","DarkGreen","MediumOrchid","BlueViolet"],this.color_map={},this.emojis=[{name:"thumb_up",code:"em-thumbsup"},{name:"thumb_down",code:"em-thumbsdown"},{name:"gesture_raised_hand",code:"em-raised_hand"},{name:"face_angry",code:"em-angry"},{name:"face_confused",code:"em-confused"},{name:"face_confounded",code:"em-confounded"},{name:"face_cry",code:"em-cry"},{name:"face_disappointed",code:"em-disappointed"},{name:"face_expressionless",code:"em-expressionless"},{name:"face_frowning",code:"em-frowning"},{name:"face_joy",code:"em-joy"},{name:"face_neutral",code:"em-neutral_face"},{name:"face_confused",code:"em-confused"},{name:"face_gasp",code:"em-open_mouth"},{name:"face_smile",code:"em-smile"},{name:"face_smirk",code:"em-smirk"},{name:"face_sweat",code:"em-sweat_smile"},{name:"face_tongue",code:"em-stuck_out_tongue"},{name:"face_tongue_eyes",code:"em-stuck_out_tongue_closed_eyes"},{name:"face_tongue_wink",code:"em-stuck_out_tongue_winking_eye"},{name:"face_worried",code:"em-worried"},{name:"item_date",code:"em-date"},{name:"item_chicken",code:"em-chicken"}],this.emoji_css="<style type='text/css'>i.em{font-size:14px;}div#previewbox{background-color:white;border-radius:5px;border:solid 1px #c0c0c0;min-height:4em;max-height:8em;overflow-y:auto;width:80%;padding:2px 6px;white-space:pre-wrap;line-height:1.25;}div#emoji_palette{border:solid 1px black;background-color:#ECECEC;display:none;}div#emoji_palette.open{display:block;}div#emoji_palette button{margin:5px;}</style>",this.document_root,this.iframe,this.userlist,this.msglist,this.msgbox,this.btnsend,this.chkEnterToSend;var t=this;this.start=function(){t.checkEnabled(),setTimeout(function(){t.setup(),e=!0},5e3),chrome.runtime.onMessage.addListener(function(e,n,o){"toggle_module"==e.action&&(t.checkEnabled(),o("checkEnabled"))})},this.setup=function(){if(t.enabled&&(t.iframe=$("iframe").contents(),$("iframe").prop("style","height:720px"),t.document_root=t.iframe.find("html"),t.userlist=t.iframe.find("#userlst_id"),t.msglist=t.iframe.find("#msglst_id"),t.msgbox=t.iframe.find("#d2l_form textarea"),t.btnsend=t.iframe.find("#d2l_form a[id*=z_]"),0!=t.userlist.length||0!=t.msglist.length||(t.document_root=$("html"),t.userlist=$("#userlst_id"),t.msglist=$("#msglst_id"),t.msgbox=$("#d2l_form textarea"),t.btnsend=$("#d2l_form a[id*=z_]"),0!=t.userlist.length||0!=t.msglist.length))){t.document_root.find("head").append("<link href='https://afeld.github.io/emoji-css/emoji.css' rel='stylesheet'>"),t.document_root.find("head").append(t.emoji_css);var e=$("<div id='snd_wrap' style='display:inline-block;'></div>");t.btnsend.wrap(e),e=t.document_root.find("#snd_wrap"),t.chkEnterToSend=$("<input type='checkbox' name='enter_to_send' id='enter_to_send' />").insertAfter(t.btnsend),$("<label for='enter_to_send'>Enter to Send</label>").insertAfter(t.chkEnterToSend),$("</br>").insertAfter(t.btnsend);var n=$("<div id='previewbox'><div>");n.insertAfter(e),t.btnsend.on("click",function(){n.html("")}),$("<div>Preview:</div>").insertBefore(n);var o=$("<button><i class='em em-grinning'></i></button>"),i=$("<div id='emoji_palette'></div>");$(o).insertAfter(n),o.on("click",function(){i.hasClass("open")?i.removeClass("open"):i.addClass("open")}),$(i).insertAfter(o);var a="",s="<br>";t.emojis.forEach(function(e,t){a+="<button title='"+e.name+"'><i class='em "+e.code+"'></i></button>",(t+1)%13==0&&(a+=s)}),$(i).append(a),$(i).find("button").each(function(e,n){$(n).on("click",function(){var n=t.msgbox.val(),o=t.msgbox[0].selectionStart,i=n.substring(0,o),a=n.substring(o),s=":"+t.emojis[e].name+":";t.msgbox.val(i+s+a),t.msgbox.trigger("keyup"),t.msgbox.focus(),t.msgbox[0].selectionStart=o+s.length,t.msgbox[0].selectionEnd=o+s.length})}),t.msgbox.on("keyup",function(e){if(13==e.which&&1==t.chkEnterToSend.prop("checked"))t.btnsend[0].click();else{selectionIndex=t.msgbox[0].selectionStart;var o=t.msgbox.val();t.emojis.forEach(function(e,t){o=o.replace(new RegExp(":"+e.name+":","g"),"<i class='em "+e.code+"'></i>")}),n.html(o)}}),t.userlist.find("li").each(function(e,n){var o=$(n).text(),i=t.colors[t.user_count];t.color_map[o]=i,t.user_count++}),t.userlist.find("li span").each(function(e,n){var o=$(n).text();$(n).prop("style","color:"+t.color_map[o])}),t.msglist.find("div").each(function(e,t){$(t).prop("style","white-space:pre-wrap;background-color:#EFEFEF;margin:5px 0;padding:5px;border-radius:10px;")}),t.msglist.find("h3 span").each(function(e,n){var o=$(n).text().replace(":","");$(n).prop("style","font-weight:bold;color:"+t.color_map[o])}),t.userlist.on("contentChanged",t.pollUsers),t.msglist.on("contentChanged",t.pollMessages),t.loaded=!0,t.update()}};var n,o;this.update=function(){i.log("Plato Enhancement Suite: Chatter has started!"),chrome.runtime.sendMessage({action:"update_popup_from_module"},null),t.updateloop=setInterval(function(){var e=t.userlist,i=t.msglist.children().length;n!==e.html()&&(n=e.html(),t.userlist.trigger("contentChanged")),o!==i&&(o=i,t.msglist.trigger("contentChanged"))},10)},this.pollUsers=function(){t.userlist.find("li").each(function(e,n){var o=$(n).text();if(!(o in t.color_map)){var i=t.colors[t.user_count];t.color_map[o]=i}$(n).find("span").prop("style","color:"+t.color_map[o])})},this.pollMessages=function(){t.msglist.find("div").each(function(e,n){$(n).prop("style","white-space:pre-wrap;background-color:#ECECEC;margin:5px 0;padding:5px;border-radius:10px;");var o=$(n).html();t.emojis.forEach(function(e,t){o=o.replace(new RegExp(":"+e.name+":","g"),"<i class='em "+e.code+"'></i>")}),$(n).html(o)}),t.msglist.find("h3 span").each(function(e,n){var o=$(n).text().replace(":","");$(n).prop("style","font-weight:bold;color:"+t.color_map[o])})},this.checkEnabled=function(){t.settings.get("enabled_modules",function(n){var o;o=void 0==n.enabled_modules||n.enabled_modules.chatter.enabled,t.enabled!=o&&(t.enabled=o,t.enabled?e&&(t.loaded?t.update():t.setup()):(clearInterval(t.updateloop),i.log("Plato Enhancement Suite: Chatter is not running!")))})},this.info=function(){return{name:"Chatter",version:t.VERSION,is_loaded:t.loaded&&t.enabled}},this.dev=function(e){dev=e};var i={log:function(e){dev&&console.log(e)}}},c=new Chatter;module.exports.start=c.start,module.exports.getInfo=c.info,module.exports.dev=c.dev;