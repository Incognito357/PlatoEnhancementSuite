var Chatter=function(){this.VERSION="1.1.0",this.loaded=!1,this.settings=chrome.storage.local,this.enabled;var e=!1;this.updateloop,this.user_count=0,this.colors=["YellowGreen","DarkGoldenRod","Chocolate","LimeGreen","CornflowerBlue","Violet","LightSkyBlue","SaddleBrown","DarkOrange","SeaGreen","MediumVioletRed","DarkTurquoise","Olive","Tomato","DarkOliveGreen","Turquoise","DarkRed","Purple","Maroon","RebeccaPurple","DarkCyan","MediumBlue","HotPink","DeepPink","CadetBlue","PaleVioletRed","DarkOrchid","MediumPurple","Brown","DeepSkyBlue","DodgerBlue","SlateBlue","OliveDrab","OrangeRed","Coral","Crimson","Red","LightCoral","FireBrick","LightSeaGreen","MediumSlateBlue","DarkMagenta","Teal","Orchid","MidnightBlue","Orange","MediumAquaMarine","Green","DarkSalmon","DarkBlue","Navy","SteelBlue","Fuchsia","SkyBlue","ForestGreen","MediumSeaGreen","DarkViolet","RosyBrown","DarkSlateBlue","DarkSeaGreen","RoyalBlue","DarkGreen","MediumOrchid","BlueViolet"],this.color_map={},this.emojis=[{name:"thumb_up",code:"em-thumbsup"},{name:"thumb_down",code:"em-thumbsdown"},{name:"gesture_raised_hand",code:"em-raised_hand"},{name:"face_angry",code:"em-angry"},{name:"face_confused",code:"em-confused"},{name:"face_confounded",code:"em-confounded"},{name:"face_cry",code:"em-cry"},{name:"face_disappointed",code:"em-disappointed"},{name:"face_expressionless",code:"em-expressionless"},{name:"face_frowning",code:"em-frowning"},{name:"face_joy",code:"em-joy"},{name:"face_neutral",code:"em-neutral_face"},{name:"face_confused",code:"em-confused"},{name:"face_gasp",code:"em-open_mouth"},{name:"face_smile",code:"em-smile"},{name:"face_smirk",code:"em-smirk"},{name:"face_sweat",code:"em-sweat_smile"},{name:"face_tongue",code:"em-stuck_out_tongue"},{name:"face_tongue_eyes",code:"em-stuck_out_tongue_closed_eyes"},{name:"face_tongue_wink",code:"em-stuck_out_tongue_winking_eye"},{name:"face_worried",code:"em-worried"},{name:"item_date",code:"em-date"},{name:"item_chicken",code:"em-chicken"}],this.emoji_css="<style>i.em{font-size:14px;}div#previewbox{background-color:white;border-radius:5px;border:solid 1px #c0c0c0;min-height:4em;max-height:8em;overflow-y:auto;width:80%;padding:2px 6px;white-space:pre-wrap;line-height:1.25;}div#emoji_palette{border:solid 1px black;background-color:#ECECEC;display:none;}div#emoji_palette.open{display:block;}div#emoji_palette button{margin:5px;}</style>",this.iframe,this.userlist,this.msglist,this.msgbox,this.btnsend,this.chkEnterToSend;var n=this;this.start=function(){n.checkEnabled(),setTimeout(function(){n.setup(),e=!0},5e3),chrome.runtime.onMessage.addListener(function(e,t,o){"toggle_module"==e.action&&(n.checkEnabled(),o("checkEnabled"))})},this.setup=function(){if(n.enabled&&(n.iframe=$("iframe").contents(),n.userlist=n.iframe.find("#userlst_id"),n.msglist=n.iframe.find("#msglst_id"),n.msgbox=n.iframe.find("#d2l_form textarea"),n.btnsend=n.iframe.find("#d2l_form a[id*=z_]"),0!=n.userlist.length||0!=n.msglist.length||(n.userlist=$("#userlst_id"),n.msglist=$("#msglst_id"),n.msgbox=$("#d2l_form textarea"),n.btnsend=$("#d2l_form a[id*=z_]"),0!=n.userlist.length||0!=n.msglist.length))){$("head").append("<link href='https://afeld.github.io/emoji-css/emoji.css' rel='stylesheet'>"),$("head").append(n.emoji_css);var e=$("<div id='snd_wrap' style='display:inline-block;'></div>");n.btnsend.wrap(e),e=$("#snd_wrap"),n.chkEnterToSend=$("<input type='checkbox' name='enter_to_send' id='enter_to_send' />").insertAfter(n.btnsend),$("<label for='enter_to_send'>Enter to Send</label>").insertAfter(n.chkEnterToSend),$("</br>").insertAfter(n.btnsend);var t=$("<div id='previewbox'><div>");t.insertAfter(e),n.btnsend.on("click",function(){t.html("")}),$("<div>Preview:</div>").insertBefore(t);var o=$("<button><i class='em em-grinning'></i></button>"),i=$("<div id='emoji_palette'></div>");$(o).insertAfter(t),o.on("click",function(){i.hasClass("open")?i.removeClass("open"):i.addClass("open")}),$(i).insertAfter(o);var a="",s="<br>";n.emojis.forEach(function(e,n){a+="<button title='"+e.name+"'><i class='em "+e.code+"'></i></button>",(n+1)%13==0&&(a+=s)}),$(i).append(a),$(i).find("button").each(function(e,t){$(t).on("click",function(){var t=n.msgbox.val(),o=n.msgbox[0].selectionStart,i=t.substring(0,o),a=t.substring(o),s=":"+n.emojis[e].name+":";n.msgbox.val(i+s+a),n.msgbox.trigger("keyup"),n.msgbox.focus(),n.msgbox[0].selectionStart=o+s.length,n.msgbox[0].selectionEnd=o+s.length})}),n.msgbox.on("keyup",function(e){if(13==e.which&&1==n.chkEnterToSend.prop("checked"))n.btnsend[0].click();else{selectionIndex=n.msgbox[0].selectionStart;var o=n.msgbox.val();n.emojis.forEach(function(e,n){o=o.replace(new RegExp(":"+e.name+":","g"),"<i class='em "+e.code+"'></i>")}),t.html(o)}}),n.userlist.find("li").each(function(e,t){var o=$(t).text(),i=n.colors[n.user_count];n.color_map[o]=i,n.user_count++}),n.userlist.find("li span").each(function(e,t){var o=$(t).text();$(t).prop("style","color:"+n.color_map[o])}),n.msglist.find("div").each(function(e,n){$(n).prop("style","white-space:pre;background-color:#EFEFEF;margin:5px 0;padding:5px;border-radius:10px;")}),n.msglist.find("h3 span").each(function(e,t){var o=$(t).text().replace(":","");$(t).prop("style","font-weight:bold;color:"+n.color_map[o])}),n.userlist.on("contentChanged",n.pollUsers),n.msglist.on("contentChanged",n.pollMessages),n.loaded=!0,n.update()}};var t,o;this.update=function(){i.log("Plato Enhancement Suite: Chatter has started!"),chrome.runtime.sendMessage({action:"update_popup_from_module"},null),n.updateloop=setInterval(function(){var e=n.userlist,i=n.msglist.children().length;t!==e.html()&&(t=e.html(),n.userlist.trigger("contentChanged")),o!==i&&(o=i,n.msglist.trigger("contentChanged"))},10)},this.pollUsers=function(){n.userlist.find("li").each(function(e,t){var o=$(t).text();if(!(o in n.color_map)){var i=n.colors[n.user_count];n.color_map[o]=i}$(t).find("span").prop("style","color:"+n.color_map[o])})},this.pollMessages=function(){n.msglist.find("div").each(function(e,t){$(t).prop("style","white-space:pre;background-color:#ECECEC;margin:5px 0;padding:5px;border-radius:10px;");var o=$(t).html();n.emojis.forEach(function(e,n){o=o.replace(new RegExp(":"+e.name+":","g"),"<i class='em "+e.code+"'></i>")}),$(t).html(o)}),n.msglist.find("h3 span").each(function(e,t){var o=$(t).text().replace(":","");$(t).prop("style","font-weight:bold;color:"+n.color_map[o])})},this.checkEnabled=function(){n.settings.get("enabled_modules",function(t){var o;o=void 0==t.enabled_modules||t.enabled_modules.chatter.enabled,n.enabled!=o&&(n.enabled=o,n.enabled?e&&(n.loaded?n.update():n.setup()):(clearInterval(n.updateloop),i.log("Plato Enhancement Suite: Chatter is not running!")))})},this.info=function(){return{name:"Chatter",version:n.VERSION,is_loaded:n.loaded&&n.enabled}},this.dev=function(e){dev=e};var i={log:function(e){dev&&console.log(e)}}},c=new Chatter;module.exports.start=c.start,module.exports.getInfo=c.info,module.exports.dev=c.dev;